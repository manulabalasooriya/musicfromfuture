import React, { useEffect, useMemo, useRef, useState } from "react";
import {
  AudioLines,
  ArrowRight,
  BadgeCheck,
  CheckCircle2,
  Compass,
  Gauge,
  Layers,
  Lock,
  SlidersHorizontal,
  Sparkles,
  Star,
  Waves,
  XCircle,
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Separator } from "@/components/ui/separator";

/**
 * Landing page for: MUsic from future
 *
 * Dark theme + colorful accents.
 * 6 stages as sections (swipe/drag carousels).
 * Daily MCQ challenge as swipe/drag cards placed BELOW the stages.
 * Feature access is gated by star count earned from MCQs.
 */

function cn(...classes: Array<string | false | null | undefined>) {
  return classes.filter(Boolean).join(" ");
}

function useDragScroll<T extends HTMLElement>() {
  const ref = useRef<T | null>(null);
  const dragging = useRef(false);
  const startX = useRef(0);
  const startScrollLeft = useRef(0);

  function onPointerDown(e: React.PointerEvent) {
    if (e.pointerType === "mouse" && e.button !== 0) return;
    const el = ref.current;
    if (!el) return;

    dragging.current = true;
    startX.current = e.clientX;
    startScrollLeft.current = el.scrollLeft;
    el.setPointerCapture?.(e.pointerId);
  }

  function onPointerMove(e: React.PointerEvent) {
    const el = ref.current;
    if (!el || !dragging.current) return;

    const dx = e.clientX - startX.current;
    el.scrollLeft = startScrollLeft.current - dx;
    if (e.pointerType === "mouse") e.preventDefault();
  }

  function endDrag() {
    dragging.current = false;
  }

  return {
    ref,
    handlers: {
      onPointerDown,
      onPointerMove,
      onPointerUp: endDrag,
      onPointerCancel: endDrag,
      onPointerLeave: endDrag,
    } as const,
  };
}

type Tone = "fuchsia" | "cyan" | "indigo";

type StageCard = {
  title: string;
  desc: string;
  hint: string;
  tone: Tone;
  icon: React.ReactNode;
  requiredStars: number;
};

type StageSection = {
  id: string;
  title: string;
  subtitle: string;
  cards: StageCard[];
};

type Mcq = {
  q: string;
  options: string[];
  answerIndex: number;
  why: string;
  tone: Tone;
};

function clamp(n: number, min: number, max: number) {
  return Math.max(min, Math.min(max, n));
}

function isUnlocked(stars: number, requiredStars: number) {
  return stars >= requiredStars;
}

function todayKey() {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${yyyy}-${mm}-${dd}`;
}

const DAILY_QUIZ: Mcq[] = [
  {
    q: "In gain staging, what’s a common reason to leave headroom (e.g., peaks around -6 dBFS)?",
    options: [
      "To make the track quieter for streaming",
      "To reduce the chance of clipping and leave room for processing",
      "To increase noise floor for warmth",
      "To avoid stereo imaging changes",
    ],
    answerIndex: 1,
    why: "Headroom prevents clipping and gives plugins room to work without unwanted distortion.",
    tone: "fuchsia",
  },
  {
    q: "What’s the main goal of panning in a mix?",
    options: ["Increase loudness", "Control pitch", "Create separation and width", "Remove reverb"],
    answerIndex: 2,
    why: "Panning places elements across left-right space to reduce masking and add width.",
    tone: "cyan",
  },
  {
    q: "A typical EQ move to reduce muddiness is often in which region?",
    options: ["20–60 Hz", "200–500 Hz", "2–5 kHz", "10–18 kHz"],
    answerIndex: 1,
    why: "Muddiness often builds up in the low-mids around ~200–500 Hz.",
    tone: "indigo",
  },
  {
    q: "What does compression primarily control?",
    options: ["Stereo width", "Dynamics", "Tempo", "Phase inversion"],
    answerIndex: 1,
    why: "Compression reduces dynamic range by turning down loud parts based on threshold and ratio.",
    tone: "cyan",
  },
  {
    q: "Why check mono compatibility when panning?",
    options: [
      "Mono makes the mix louder",
      "Panning changes sample rate",
      "Some systems sum to mono and phase issues can cause cancellations",
      "Mono disables EQ",
    ],
    answerIndex: 2,
    why: "Summing to mono can reveal phase cancellations or balance problems.",
    tone: "fuchsia",
  },
];

export default function LandingPage() {
  const [email, setEmail] = useState("");
  const [submitted, setSubmitted] = useState(false);
  const year = useMemo(() => new Date().getFullYear(), []);

  // Stars + daily quiz state (demo stored locally)
  const [stars, setStars] = useState<number>(0);
  const [quizAnswers, setQuizAnswers] = useState<number[]>(() => Array(DAILY_QUIZ.length).fill(-1));
  const [quizSubmitted, setQuizSubmitted] = useState(false);
  const [quizResult, setQuizResult] = useState<{ correct: number; earned: number } | null>(null);

  const storageStarsKey = "mf_stars";
  const storageQuizKey = `mf_daily_quiz_${todayKey()}`;

  useEffect(() => {
    const raw = localStorage.getItem(storageStarsKey);
    const n = raw ? Number(raw) : 0;
    if (!Number.isNaN(n)) setStars(clamp(n, 0, 99999));

    const quizRaw = localStorage.getItem(storageQuizKey);
    if (quizRaw) {
      try {
        const parsed = JSON.parse(quizRaw) as {
          answers: number[];
          correct: number;
          earned: number;
        };
        setQuizAnswers(Array.isArray(parsed.answers) ? parsed.answers : quizAnswers);
        setQuizSubmitted(true);
        setQuizResult({ correct: parsed.correct, earned: parsed.earned });
      } catch {
        // ignore
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  useEffect(() => {
    localStorage.setItem(storageStarsKey, String(stars));
  }, [stars]);

  function onSubmitWaitlist(e: React.FormEvent) {
    e.preventDefault();
    if (!email.trim()) return;
    setSubmitted(true);
  }

  function submitQuiz() {
    if (quizSubmitted) return;
    const correct = quizAnswers.reduce((acc, ans, i) => acc + (ans === DAILY_QUIZ[i].answerIndex ? 1 : 0), 0);
    const earned = correct; // 1 star per correct answer

    setStars((s) => s + earned);
    setQuizSubmitted(true);
    setQuizResult({ correct, earned });

    localStorage.setItem(storageQuizKey, JSON.stringify({ answers: quizAnswers, correct, earned }));
  }

  function scrollToMcq() {
    const el = document.getElementById("daily-mcq");
    el?.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  const sections: StageSection[] = [
    {
      id: "gain-staging",
      title: "Gain Staging",
      subtitle: "Unlock more control and better quality as you earn stars.",
      cards: [
        {
          title: "Blackbox Gain Stage",
          desc: "Auto gain-stage your mix — without revealing the steps.",
          hint: "Fastest: one-click results",
          tone: "fuchsia",
          icon: <Gauge className="h-5 w-5" />,
          requiredStars: 0,
        },
        {
          title: "Role-based Gain Stager",
          desc: "Explainable gain staging with role-aware decisions.",
          hint: "Shows what changed + why",
          tone: "cyan",
          icon: <BadgeCheck className="h-5 w-5" />,
          requiredStars: 10,
        },
        {
          title: "AI Gain Stager — 1 Model",
          desc: "A single model that predicts clean levels per track.",
          hint: "Consistent baseline",
          tone: "indigo",
          icon: <Sparkles className="h-5 w-5" />,
          requiredStars: 25,
        },
        {
          title: "AI Gain Stager — 2 Models",
          desc: "Two-model pipeline for context + refinement.",
          hint: "Better genre translation",
          tone: "cyan",
          icon: <Layers className="h-5 w-5" />,
          requiredStars: 45,
        },
        {
          title: "AI Gain Stager — 3 Models",
          desc: "Analyze → decide → refine, for best quality.",
          hint: "Most control",
          tone: "fuchsia",
          icon: <Compass className="h-5 w-5" />,
          requiredStars: 70,
        },
      ],
    },
    {
      id: "panning",
      title: "Stereo Panning",
      subtitle: "From black-box panning to advanced spatial pipelines.",
      cards: [
        {
          title: "Blackbox Panning",
          desc: "Auto-place elements in the stereo field — no explanation.",
          hint: "Instant width + separation",
          tone: "cyan",
          icon: <SlidersHorizontal className="h-5 w-5" />,
          requiredStars: 0,
        },
        {
          title: "Explainable Panning",
          desc: "Shows panning rules and decisions per element.",
          hint: "Learn placement strategies",
          tone: "indigo",
          icon: <BadgeCheck className="h-5 w-5" />,
          requiredStars: 15,
        },
        {
          title: "Panning with Ambisonics",
          desc: "Spatial positioning using ambisonic representations.",
          hint: "Better depth + motion",
          tone: "fuchsia",
          icon: <Waves className="h-5 w-5" />,
          requiredStars: 35,
        },
        {
          title: "Ambisonics + Diffusion",
          desc: "Diffuse spatial energy for smoother width.",
          hint: "More natural space",
          tone: "cyan",
          icon: <Sparkles className="h-5 w-5" />,
          requiredStars: 55,
        },
        {
          title: "Ambisonics + Diffusion + Binaural",
          desc: "Full spatial pipeline ending with binaural decoding.",
          hint: "Headphone-ready 3D",
          tone: "indigo",
          icon: <Compass className="h-5 w-5" />,
          requiredStars: 85,
        },
      ],
    },
    {
      id: "equalization",
      title: "Equalization",
      subtitle: "Unlock black-box speed, explainable learning, and AI pipelines.",
      cards: [
        {
          title: "Blackbox EQ",
          desc: "Automatic EQ that just sounds better.",
          hint: "No knobs, just results",
          tone: "indigo",
          icon: <AudioLines className="h-5 w-5" />,
          requiredStars: 0,
        },
        {
          title: "Explainable EQ",
          desc: "Shows cuts/boosts and explains what they target.",
          hint: "Mud • harshness • resonance",
          tone: "cyan",
          icon: <BadgeCheck className="h-5 w-5" />,
          requiredStars: 20,
        },
        {
          title: "AI EQ Pipelines",
          desc: "Progressive EQ refinement with model guidance.",
          hint: "1→2→3 models",
          tone: "fuchsia",
          icon: <Layers className="h-5 w-5" />,
          requiredStars: 60,
        },
      ],
    },
    {
      id: "compression",
      title: "Compression",
      subtitle: "Tight dynamics, more punch — with teachable controls.",
      cards: [
        {
          title: "Blackbox Compression",
          desc: "Automatic dynamics control without exposing parameters.",
          hint: "Quick, musical results",
          tone: "cyan",
          icon: <Waves className="h-5 w-5" />,
          requiredStars: 0,
        },
        {
          title: "Explainable Compression",
          desc: "Explains threshold/ratio/attack/release decisions.",
          hint: "Shows gain reduction",
          tone: "indigo",
          icon: <BadgeCheck className="h-5 w-5" />,
          requiredStars: 25,
        },
        {
          title: "AI Compression Pipelines",
          desc: "Multi-stage dynamics that adapts to content.",
          hint: "Transient-aware refinement",
          tone: "fuchsia",
          icon: <Layers className="h-5 w-5" />,
          requiredStars: 65,
        },
      ],
    },
    {
      id: "reverb",
      title: "Reverb",
      subtitle: "Depth, space, and realism — from presets to AI refinement.",
      cards: [
        {
          title: "Blackbox Reverb",
          desc: "Automatic space with a single toggle.",
          hint: "Clean depth, low clutter",
          tone: "fuchsia",
          icon: <Sparkles className="h-5 w-5" />,
          requiredStars: 0,
        },
        {
          title: "Explainable Reverb",
          desc: "Shows room choice, pre-delay, decay, and mix level.",
          hint: "Teaches placement",
          tone: "cyan",
          icon: <BadgeCheck className="h-5 w-5" />,
          requiredStars: 25,
        },
        {
          title: "AI Reverb Pipelines",
          desc: "Model-guided reverb selection and refinement.",
          hint: "Context-aware ambience",
          tone: "indigo",
          icon: <Layers className="h-5 w-5" />,
          requiredStars: 65,
        },
      ],
    },
    {
      id: "synchronization",
      title: "Synchronization",
      subtitle: "Tight timing alignment for cleaner mixes and better groove.",
      cards: [
        {
          title: "Blackbox Sync",
          desc: "Align timing automatically with minimal controls.",
          hint: "Instant tightness",
          tone: "indigo",
          icon: <Compass className="h-5 w-5" />,
          requiredStars: 0,
        },
        {
          title: "Explainable Sync",
          desc: "Shows what shifted and how alignment was decided.",
          hint: "Transient + beat maps",
          tone: "cyan",
          icon: <BadgeCheck className="h-5 w-5" />,
          requiredStars: 20,
        },
        {
          title: "AI Sync Pipelines",
          desc: "Multi-stage alignment that preserves feel.",
          hint: "Groove retention",
          tone: "fuchsia",
          icon: <Layers className="h-5 w-5" />,
          requiredStars: 55,
        },
      ],
    },
  ];

  // Tiny sanity tests (console)
  useEffect(() => {
    console.assert(isUnlocked(10, 10) === true, "unlock test failed");
    console.assert(isUnlocked(9, 10) === false, "lock test failed");
  }, []);

  const unlockedCount = sections.reduce(
    (acc, s) => acc + s.cards.reduce((a, c) => a + (isUnlocked(stars, c.requiredStars) ? 1 : 0), 0),
    0
  );
  const totalCards = sections.reduce((acc, s) => acc + s.cards.length, 0);

  return (
    <div className="dark min-h-screen bg-background text-foreground">
      <Header stars={stars} />

      {/* Background */}
      <div className="pointer-events-none fixed inset-0 -z-10">
        <div className="absolute inset-0 bg-[#07080c]" />
        <div className="absolute -top-44 left-1/2 h-[560px] w-[560px] -translate-x-1/2 rounded-full bg-fuchsia-500/22 blur-3xl" />
        <div className="absolute -bottom-52 right-[-18%] h-[560px] w-[560px] rounded-full bg-cyan-400/20 blur-3xl" />
        <div className="absolute top-24 left-[-18%] h-[520px] w-[520px] rounded-full bg-indigo-500/18 blur-3xl" />
        <div className="absolute inset-0 opacity-[0.12] [background-image:linear-gradient(to_right,rgba(255,255,255,0.10)_1px,transparent_1px),linear-gradient(to_bottom,rgba(255,255,255,0.10)_1px,transparent_1px)] [background-size:44px_44px]" />
        <div className="absolute inset-0 bg-[radial-gradient(70%_60%_at_50%_0%,transparent_0%,rgba(0,0,0,0.50)_70%,rgba(0,0,0,0.74)_100%)]" />
      </div>

      <main className="mx-auto max-w-4xl px-4 pb-14 pt-12 sm:pt-14">
        {/* HERO */}
        <section className="text-center">
          <div className="mx-auto inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-4 py-2 text-sm text-white/70 backdrop-blur">
            <Sparkles className="h-4 w-4 text-fuchsia-300" />
            <span>AI audio tools + learning platform</span>
          </div>

          <h1 className="mt-5 text-balance text-4xl font-semibold tracking-tight sm:text-6xl">
            MUsic from{" "}
            <span className="relative inline-block">
              <span className="relative z-10 bg-gradient-to-r from-fuchsia-300 via-indigo-200 to-cyan-200 bg-clip-text text-transparent">
                future
              </span>
              <span className="absolute -inset-x-2 -inset-y-1 -z-0 rounded-2xl bg-white/5" />
            </span>
          </h1>

          <p className="mx-auto mt-4 max-w-2xl text-pretty text-base text-white/70 sm:text-lg">
            Earn stars by answering daily MCQs. Stars unlock black-box tools, explainable modes, and
            advanced multi-model pipelines across every mixing stage.
          </p>

          <div className="mt-8 flex flex-col items-stretch justify-center gap-3 sm:flex-row sm:items-center">
            <Button
              size="lg"
              className="rounded-2xl bg-gradient-to-r from-fuchsia-500 via-indigo-500 to-cyan-400 text-white shadow-lg shadow-fuchsia-500/12 hover:opacity-95"
            >
              Try the demo <ArrowRight className="ml-2 h-4 w-4" />
            </Button>
            <Button
              size="lg"
              variant="secondary"
              className="rounded-2xl bg-white/7 text-white/85 hover:bg-white/10"
              onClick={scrollToMcq}
            >
              Do today’s MCQs
            </Button>
          </div>

          <div className="mt-8 grid gap-3 sm:grid-cols-3">
            <MiniPoint icon={<Star className="h-4 w-4 text-yellow-200" />} text={`${stars} stars earned`} />
            <MiniPoint
              icon={<BadgeCheck className="h-4 w-4 text-cyan-200" />}
              text={`${unlockedCount}/${totalCards} unlocked`}
            />
            <MiniPoint icon={<Compass className="h-4 w-4 text-fuchsia-200" />} text="Learn by doing" />
          </div>

          <div className="mx-auto mt-10 max-w-3xl">
            <WaveDivider />
          </div>
        </section>

        {/* STAGE SECTIONS (6 stages) */}
        <div className="mt-10 space-y-8">
          {sections.map((s) => (
            <StageCarousel key={s.id} section={s} stars={stars} />
          ))}
        </div>

        {/* DAILY MCQ — BELOW the 6 stages */}
        <section className="mt-10" id="daily-mcq">
          <QuizCarousel
            stars={stars}
            today={todayKey()}
            items={DAILY_QUIZ}
            answers={quizAnswers}
            setAnswers={setQuizAnswers}
            submitted={quizSubmitted}
            result={quizResult}
            onSubmit={submitQuiz}
            onReset={() => {
              localStorage.removeItem(storageQuizKey);
              setQuizAnswers(Array(DAILY_QUIZ.length).fill(-1));
              setQuizSubmitted(false);
              setQuizResult(null);
            }}
          />
        </section>

        {/* WAITLIST */}
        <section className="mt-10">
          <Card className="rounded-3xl border border-white/10 bg-white/5 backdrop-blur">
            <CardContent className="p-6 sm:p-8">
              <div className="flex flex-col gap-6 sm:flex-row sm:items-center sm:justify-between">
                <div>
                  <h2 className="text-xl font-semibold tracking-tight sm:text-2xl">Join the waitlist</h2>
                  <p className="mt-2 text-sm text-white/70">Get beta access and updates. No spam.</p>
                </div>

                <form onSubmit={onSubmitWaitlist} className="w-full max-w-md">
                  <div className="flex flex-col gap-3 sm:flex-row">
                    <Input
                      className="h-11 rounded-2xl border-white/10 bg-white/5 text-white placeholder:text-white/40"
                      type="email"
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      placeholder="you@example.com"
                      aria-label="Email"
                    />
                    <Button
                      className="h-11 rounded-2xl bg-gradient-to-r from-fuchsia-500 via-indigo-500 to-cyan-400 text-white shadow-lg shadow-indigo-500/12 hover:opacity-95"
                      type="submit"
                      disabled={submitted}
                    >
                      {submitted ? "Added" : "Notify me"}
                    </Button>
                  </div>
                  <p className="mt-2 text-xs text-white/55">Founding member perks included.</p>
                </form>
              </div>
            </CardContent>
          </Card>
        </section>

        <Separator className="my-10 bg-white/10" />

        <footer className="flex flex-col gap-2 text-center text-xs text-white/55">
          <div>© {year} MUsic from future</div>
          <div className="inline-flex items-center justify-center gap-2">
            <AudioLines className="h-4 w-4 text-white/70" />
            <span>Web-first audio workflows</span>
          </div>
        </footer>
      </main>
    </div>
  );
}

function StageCarousel({
  section,
  stars,
}: {
  section: StageSection;
  stars: number;
}) {
  const carousel = useDragScroll<HTMLDivElement>();

  return (
    <section id={section.id}>
      <Card className="rounded-3xl border border-white/10 bg-white/5 backdrop-blur">
        <CardContent className="p-6 sm:p-8">
          <div className="flex items-start justify-between gap-4">
            <div>
              <h2 className="text-xl font-semibold tracking-tight sm:text-2xl">{section.title}</h2>
              <p className="mt-2 text-sm text-white/70">{section.subtitle}</p>
            </div>
            <div className="hidden items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs text-white/60 sm:inline-flex">
              <span>Swipe</span>
              <span aria-hidden>→</span>
            </div>
          </div>

          <div
            ref={carousel.ref}
            {...carousel.handlers}
            className={cn(
              "mt-6 -mx-2 flex gap-3 overflow-x-auto px-2 pb-2",
              "snap-x snap-mandatory scroll-smooth overscroll-x-contain",
              "select-none touch-pan-x cursor-grab active:cursor-grabbing",
              "[scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden"
            )}
          >
            {section.cards.map((c) => {
              const unlocked = isUnlocked(stars, c.requiredStars);
              return (
                <div key={c.title} className="min-w-[320px] snap-start">
                  <MixCard
                    icon={c.icon}
                    title={c.title}
                    desc={c.desc}
                    hint={c.hint}
                    tone={c.tone}
                    requiredStars={c.requiredStars}
                    unlocked={unlocked}
                    currentStars={stars}
                  />
                </div>
              );
            })}
          </div>

          <p className="mt-3 text-xs text-white/55">Desktop: click and drag the row.</p>
        </CardContent>
      </Card>
    </section>
  );
}

function QuizCarousel({
  stars,
  today,
  items,
  answers,
  setAnswers,
  submitted,
  result,
  onSubmit,
  onReset,
}: {
  stars: number;
  today: string;
  items: Mcq[];
  answers: number[];
  setAnswers: React.Dispatch<React.SetStateAction<number[]>>;
  submitted: boolean;
  result: { correct: number; earned: number } | null;
  onSubmit: () => void;
  onReset: () => void;
}) {
  const carousel = useDragScroll<HTMLDivElement>();

  const answeredCount = answers.filter((a) => a >= 0).length;
  const allAnswered = answeredCount === items.length;

  return (
    <Card className="rounded-3xl border border-white/10 bg-white/5 backdrop-blur">
      <CardContent className="p-6 sm:p-8">
        <div className="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
          <div>
            <h2 className="text-xl font-semibold tracking-tight sm:text-2xl">Daily MCQ Challenge</h2>
            <p className="mt-2 text-sm text-white/70">
              Answer today’s questions to earn stars. Stars unlock advanced features.
            </p>
            <div className="mt-3 flex flex-wrap items-center gap-2">
              <Chip tone="cyan" icon={<Star className="h-4 w-4 text-yellow-200" />} label={`${stars} stars`} />
              <Chip tone="indigo" label={`${answeredCount}/${items.length} answered`} />
              <Chip tone="fuchsia" label={`Today · ${today}`} />
            </div>
          </div>

          <div className="rounded-3xl border border-white/10 bg-black/30 p-4">
            <div className="text-xs text-white/55">Reward</div>
            <div className="mt-1 text-sm text-white/80">
              <span className="font-semibold">1 star</span> per correct answer
            </div>
            <div className="mt-2 text-xs text-white/55">Complete once per day</div>
          </div>
        </div>

        <div
          ref={carousel.ref}
          {...carousel.handlers}
          className={cn(
            "mt-6 -mx-2 flex gap-3 overflow-x-auto px-2 pb-2",
            "snap-x snap-mandatory scroll-smooth overscroll-x-contain",
            "select-none touch-pan-x cursor-grab active:cursor-grabbing",
            "[scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden"
          )}
        >
          {items.map((item, idx) => (
            <div key={item.q} className="min-w-[360px] snap-start">
              <McqCard
                idx={idx}
                item={item}
                chosen={answers[idx]}
                setChosen={(choice) =>
                  setAnswers((prev) => {
                    const next = [...prev];
                    next[idx] = choice;
                    return next;
                  })
                }
                submitted={submitted}
              />
            </div>
          ))}
        </div>

        <div className="mt-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div className="text-sm text-white/70">
            {submitted ? (
              <span>
                Completed today’s quiz. You earned{" "}
                <span className="font-semibold text-white">{result?.earned ?? 0}</span> stars
                ({result?.correct ?? 0}/{items.length}).
              </span>
            ) : (
              <span>Swipe the cards, answer all questions, then submit.</span>
            )}
          </div>

          <div className="flex flex-wrap gap-2">
            <Button
              type="button"
              variant="secondary"
              className="rounded-2xl bg-white/7 text-white/85 hover:bg-white/10"
              onClick={onReset}
            >
              Reset (demo)
            </Button>
            <Button
              type="button"
              className="rounded-2xl bg-gradient-to-r from-fuchsia-500 via-indigo-500 to-cyan-400 text-white shadow-lg shadow-indigo-500/12 hover:opacity-95"
              disabled={submitted || !allAnswered}
              onClick={onSubmit}
            >
              {submitted ? "Completed" : "Submit & Earn Stars"}
            </Button>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}

function McqCard({
  idx,
  item,
  chosen,
  setChosen,
  submitted,
}: {
  idx: number;
  item: Mcq;
  chosen: number;
  setChosen: (choice: number) => void;
  submitted: boolean;
}) {
  const correct = item.answerIndex;
  const isChosen = chosen >= 0;
  const isCorrect = chosen === correct;

  const toneStyles =
    item.tone === "fuchsia"
      ? {
          glow: "bg-fuchsia-500/22",
          line: "from-fuchsia-500/0 via-fuchsia-400/70 to-fuchsia-500/0",
          badge: "border-fuchsia-500/25 bg-fuchsia-500/10 text-fuchsia-100",
        }
      : item.tone === "cyan"
        ? {
            glow: "bg-cyan-400/20",
            line: "from-cyan-500/0 via-cyan-300/70 to-cyan-500/0",
            badge: "border-cyan-400/25 bg-cyan-400/10 text-cyan-100",
          }
        : {
            glow: "bg-indigo-500/20",
            line: "from-indigo-500/0 via-indigo-300/70 to-indigo-500/0",
            badge: "border-indigo-400/25 bg-indigo-500/10 text-indigo-100",
          };

  const status = !submitted
    ? { label: isChosen ? "Answered" : "Not answered", icon: null }
    : isCorrect
      ? { label: "+1 ★", icon: <CheckCircle2 className="h-4 w-4 text-emerald-200" /> }
      : { label: "0 ★", icon: <XCircle className="h-4 w-4 text-rose-200" /> };

  return (
    <div className="group relative overflow-hidden rounded-3xl border border-white/10 bg-black/30 p-5 backdrop-blur">
      <div className={cn("pointer-events-none absolute -right-12 -top-12 h-40 w-40 rounded-full blur-3xl", toneStyles.glow)} />
      <div className={cn("pointer-events-none absolute bottom-0 left-0 h-[2px] w-full bg-gradient-to-r opacity-90", toneStyles.line)} />

      <div className="flex items-start justify-between gap-4">
        <div className={cn("rounded-full border px-3 py-1 text-xs", toneStyles.badge)}>
          MCQ #{idx + 1}
        </div>
        <div className="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs text-white/70">
          {status.icon}
          <span>{status.label}</span>
        </div>
      </div>

      <div className="mt-4 text-sm font-semibold text-white/90">{item.q}</div>

      <div className="mt-4 grid gap-2">
        {item.options.map((opt, oi) => {
          const selected = chosen === oi;
          const showEval = submitted;
          const right = showEval && oi === correct;
          const wrong = showEval && selected && oi !== correct;

          return (
            <button
              key={opt}
              type="button"
              disabled={submitted}
              onClick={() => setChosen(oi)}
              // Prevent drag-scroll hook from capturing pointer when clicking options
              onPointerDown={(e) => e.stopPropagation()}
              onPointerMove={(e) => e.stopPropagation()}
              className={cn(
                "w-full rounded-2xl border px-4 py-3 text-left text-sm transition",
                "border-white/10 bg-white/5 hover:bg-white/8",
                selected && "bg-white/10",
                right && "border-emerald-400/30 bg-emerald-400/10",
                wrong && "border-rose-400/30 bg-rose-400/10"
              )}
            >
              <div className="flex items-start justify-between gap-3">
                <span className="text-white/80">{opt}</span>
                {submitted && selected && (isCorrect ? (
                  <CheckCircle2 className="h-4 w-4 text-emerald-200" />
                ) : (
                  <XCircle className="h-4 w-4 text-rose-200" />
                ))}
                {submitted && right && !selected && (
                  <CheckCircle2 className="h-4 w-4 text-emerald-200" />
                )}
              </div>
            </button>
          );
        })}
      </div>

      {submitted && (
        <div className="mt-4 rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-xs text-white/75">
          <span className="font-semibold">Why:</span> {item.why}
        </div>
      )}

      {!submitted && (
        <div className="mt-4 flex items-center gap-2 text-xs text-white/55">
          <Star className="h-4 w-4 text-yellow-200" />
          <span>Answer correctly to earn 1 star</span>
        </div>
      )}
    </div>
  );
}

function Chip({
  label,
  icon,
  tone,
}: {
  label: string;
  icon?: React.ReactNode;
  tone: Tone;
}) {
  const klass =
    tone === "fuchsia"
      ? "border-fuchsia-500/20 bg-fuchsia-500/10 text-fuchsia-100"
      : tone === "cyan"
        ? "border-cyan-400/20 bg-cyan-400/10 text-cyan-100"
        : "border-indigo-400/20 bg-indigo-500/10 text-indigo-100";

  return (
    <div className={cn("inline-flex items-center gap-2 rounded-full border px-3 py-1 text-xs", klass)}>
      {icon}
      <span>{label}</span>
    </div>
  );
}

function Header({ stars }: { stars: number }) {
  return (
    <header className="sticky top-0 z-50 border-b border-white/10 bg-black/40 backdrop-blur">
      <div className="mx-auto flex max-w-6xl items-center justify-between px-4 py-3">
        <div className="flex items-center gap-2">
          <div className="grid h-10 w-10 place-items-center rounded-2xl border border-white/10 bg-gradient-to-br from-fuchsia-500/20 via-indigo-500/10 to-cyan-400/20">
            <AudioLines className="h-5 w-5 text-white/90" />
          </div>
          <div className="leading-tight">
            <div className="text-sm font-semibold">MUsic from future</div>
            <div className="text-xs text-white/55">AI audio tools + learning</div>
          </div>
        </div>

        <div className="flex items-center gap-2">
          <div className="hidden items-center gap-2 rounded-2xl border border-white/10 bg-white/5 px-3 py-2 text-sm text-white/80 sm:inline-flex">
            <Star className="h-4 w-4 text-yellow-200" />
            <span className="font-semibold">{stars}</span>
            <span className="text-white/55">stars</span>
          </div>
          <Button variant="ghost" className="rounded-2xl text-white/80 hover:bg-white/10 hover:text-white">
            Sign in
          </Button>
          <Button className="rounded-2xl bg-white/10 text-white hover:bg-white/15">Get early access</Button>
        </div>
      </div>
    </header>
  );
}

function MiniPoint({
  icon,
  text,
}: {
  icon: React.ReactNode;
  text: string;
}) {
  return (
    <div className="rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm backdrop-blur">
      <div className="flex items-center justify-center gap-2 text-white/70">
        {icon}
        <span>{text}</span>
      </div>
    </div>
  );
}

function MixCard({
  icon,
  title,
  desc,
  hint,
  tone,
  requiredStars,
  unlocked,
  currentStars,
}: {
  icon: React.ReactNode;
  title: string;
  desc: string;
  hint: string;
  tone: Tone;
  requiredStars: number;
  unlocked: boolean;
  currentStars: number;
}) {
  const toneStyles =
    tone === "fuchsia"
      ? {
          glow: "bg-fuchsia-500/22",
          chip: "border-fuchsia-500/25 bg-fuchsia-500/10 text-fuchsia-100",
          line: "from-fuchsia-500/0 via-fuchsia-400/70 to-fuchsia-500/0",
          iconBg: "from-fuchsia-500/22 to-fuchsia-500/6",
        }
      : tone === "cyan"
        ? {
            glow: "bg-cyan-400/20",
            chip: "border-cyan-400/25 bg-cyan-400/10 text-cyan-100",
            line: "from-cyan-500/0 via-cyan-300/70 to-cyan-500/0",
            iconBg: "from-cyan-400/20 to-cyan-400/6",
          }
        : {
            glow: "bg-indigo-500/20",
            chip: "border-indigo-400/25 bg-indigo-500/10 text-indigo-100",
            line: "from-indigo-500/0 via-indigo-300/70 to-indigo-500/0",
            iconBg: "from-indigo-500/20 to-indigo-500/6",
          };

  const statusChip = unlocked
    ? {
        text: "Unlocked",
        icon: <CheckCircle2 className="h-4 w-4 text-emerald-200" />,
        className: "border-emerald-400/25 bg-emerald-400/10 text-emerald-100",
      }
    : {
        text: `Locked · ${requiredStars}★`,
        icon: <Lock className="h-4 w-4 text-white/70" />,
        className: "border-white/10 bg-white/5 text-white/70",
      };

  const missing = Math.max(0, requiredStars - currentStars);

  return (
    <div
      className={cn(
        "group relative overflow-hidden rounded-3xl border border-white/10 bg-black/30 p-5 backdrop-blur",
        "transition-transform duration-200 hover:-translate-y-0.5",
        !unlocked && "opacity-85"
      )}
    >
      <div className={cn("pointer-events-none absolute -right-12 -top-12 h-40 w-40 rounded-full blur-3xl", toneStyles.glow)} />
      <div className={cn("pointer-events-none absolute bottom-0 left-0 h-[2px] w-full bg-gradient-to-r opacity-90", toneStyles.line)} />

      <div className="flex items-start justify-between gap-4">
        <div
          className={cn(
            "grid h-11 w-11 place-items-center rounded-2xl border border-white/10 bg-gradient-to-br",
            toneStyles.iconBg
          )}
        >
          <span className="text-white/90">{icon}</span>
        </div>

        <div className={cn("inline-flex items-center gap-2 rounded-full border px-3 py-1 text-xs", statusChip.className)}>
          {statusChip.icon}
          <span>{statusChip.text}</span>
        </div>
      </div>

      <div className="mt-4">
        <div className="text-base font-semibold tracking-tight">{title}</div>
        <div className="mt-1 text-sm text-white/70">{desc}</div>
      </div>

      <div className="mt-4 rounded-2xl border border-white/10 bg-white/5 px-4 py-3">
        <div className="text-xs text-white/55">Quick insight</div>
        <div className="mt-1 text-sm text-white/85">{hint}</div>
      </div>

      {!unlocked && (
        <div className="mt-4 rounded-2xl border border-white/10 bg-black/20 px-4 py-3 text-xs text-white/70">
          Earn <span className="font-semibold text-white">{missing}</span> more stars to unlock.
        </div>
      )}

      <div className="mt-4 flex items-center gap-2 text-xs text-white/55">
        <span className={cn("inline-flex h-2 w-2 rounded-full", toneStyles.glow)} />
        <span>{unlocked ? "Available now" : "Unlock via daily MCQs"}</span>
      </div>
    </div>
  );
}

function WaveDivider() {
  return (
    <div className="relative">
      <div className="absolute inset-x-0 -top-2 h-6 bg-gradient-to-b from-transparent to-black/30" />
      <svg viewBox="0 0 1200 120" preserveAspectRatio="none" className="h-10 w-full opacity-70" aria-hidden>
        <path
          d="M0,64 C120,88 240,40 360,64 C480,88 600,40 720,64 C840,88 960,40 1080,64 C1140,76 1170,80 1200,76 L1200,120 L0,120 Z"
          fill="currentColor"
          className="text-white/10"
        />
      </svg>
    </div>
  );
}
